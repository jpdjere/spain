var PROXY_URL="http://localhost:3000/",comenzarChat=function(){if(resetStore(),setTimeout(function(){_abrirChat.className+=" active",setTimeout(function(){_abrirChat.className+=" inital-view",setTimeout(function(){_abrirChat.className=_abrirChat.className.replace("inital-view","")},4e3)},1e3)},1e3),sesion){var e=store.getConversation();if(e){_ventanaChat.innerHTML="",e=e||store.getConversation();var a=_body.className;a+=" display-chat",_body.className=a,e?renderearConversacion(e):(sesion=!0,enviarMensaje(start_message))}}},abrirChat=function(e){_ventanaChat.innerHTML="";var a=a||store.getConversation(),t=_body.className;t+=" display-chat",_body.className=t,a?renderearConversacion(a):(sesion=!0,enviarMensaje(start_message))},cerrarChat=function(e){e.preventDefault(),mostrarSatisfaccion()},minimizarChat=function(e){e.preventDefault(),pausarConversacion()},esconderCerrarPopup=function(){_cerrarPopup.className=_cerrarPopup.className.replace("active","")},mostrarSatisfaccion=function(){reiniciarEstrellas(),resetStore(),_satisfaccion.className=_satisfaccion.className.replace("active",""),_satisfaccion.className+=" active"},enviarSatisfaccion=function(e){e.preventDefault(),_enviarSatisfaccion.className.indexOf("active")>-1&&(_satisfaccion.className=_satisfaccion.className.replace("success",""),_satisfaccion.className+=" success")},enviarSatisfaccionNula=function(e){e.preventDefault(),cerrarSatisfaccion()},cerrarSatisfaccion=function(){_satisfaccion.className=_satisfaccion.className.replace("active",""),_satisfaccion.className=_satisfaccion.className.replace("success",""),_body.className=_body.className.replace("display-chat","").trim()},minimizarSatisfaccion=function(e){e.preventDefault(),pausarConversacion()},botonEnviar=function(e){e.preventDefault(),_msjChat.value&&escribirEnviarMensaje(_msjChat.value)},documentSe=function(e){sesion=!1,_msjChat.value="",struct=document.createElement("div"),struct.className="message error",struct.innerHTML='<div class="message-meta"></div><div class="message-block"><p>Tu sesión ha expirado.</p></div>',_ventanaChat.appendChild(struct),_ventanaChat.scrollTop=_ventanaChat.scrollHeight},chatWindowClick=function(e){"showPossibleQuestions"==e.target.className?mostrarPreguntasPosibles(e.target):"removePossibleQuestions"==e.target.className&&borrarPreguntasPosibles(e.target)},pausarConversacion=function(){var e=_body.className;e=e.replace("display-chat","").trim(),_body.className=e},responder=function(e){if(e){var a="";if("string"==typeof e.Datos.TextoConsulta)a+="Hubo un error. Por favor intenta más tarde.";else for(s=0;s<e.Datos.Respuesta.texto.length;s++){if("<p"==e.Datos.Respuesta.texto[s].substring(0,2)?a+=e.Datos.Respuesta.texto[s]:a+="<p>"+e.Datos.Respuesta.texto[s]+"</p>",e.Datos.Contexto.USR_03_options){for(a+='<ul class="answer-options">',s=0;s<e.Datos.Contexto.USR_03_options.length;s++)a+="<li><a onclick=\"escribirEnviarMensaje('"+e.Datos.Contexto.USR_04_options_questions[s]+"');\">"+e.Datos.Contexto.USR_03_options[s]+"</a></li>";a+="</ul>"}console.log(e.Datos.Contexto.USR_03_options)}var t="";if(e.Datos.Contexto&&e.Datos.Contexto.USR_02_suggestion_topics&&e.Datos.Contexto.USR_02_suggestion_topics.length){t+='<div class="header"><h2>Puedo sugerirte</h2></div>',t+="<ul>";for(var s in e.Datos.Contexto.USR_02_suggestion_topics)t+="<li><a onclick=\"escribirEnviarMensaje('"+e.Datos.Contexto.USR_02_suggestion_topics[s]+"');\">"+e.Datos.Contexto.USR_02_suggestion_topics[s]+"</a></li>";t+="</ul>"}var n="";if(e.Datos.Contexto.USR_01_alt_questions.length){n+='<ul class="answer-options">';for(s=0;s<e.Datos.Contexto.USR_01_alt_questions.length;s++)n+='<li><a class="possibleQuestion" onclick="escribirEnviarMensaje(\''+e.Datos.Contexto.USR_01_alt_questions[s]+"');\">"+e.Datos.Contexto.USR_01_alt_questions[s]+"</a></li>";n+="</ul>"}var o={from:"watson",message:a,suggestion:t,possible_questions:n,time:currentTime()};o.context=e.Datos.Contexto,store.saveMessage(o),escribirRespuesta(o)}},escribirRespuesta=function(e){esconderLoad(),addGala(),messageSuccess=document.createElement("div"),messageSuccess.className="message received",messageSuccess.innerHTML='<div class="message-block">'+e.message+'</div><div class="time">'+e.time+"</div>",_ventanaChat.appendChild(messageSuccess),addMessageClear();var a=messageSuccess.offsetHeight+20;if(e.possible_questions){for(var t=document.getElementsByClassName("possible-questions"),s=0;s<t.length;s++)_ventanaChat.removeChild(t[s]);messagePossibleQuestions=document.createElement("div"),messagePossibleQuestions.className="possible-questions",messagePossibleQuestions.innerHTML='<p>¿Esto responde a tu pregunta? <a class="borrarPreguntasPosibles" id="bad">Si</a> - <a class="mostrarPreguntasPosibles">No</a></p><div class="hidden-possible-questions"><p>A lo mejor quisiste preguntar por esto:</p>'+e.possible_questions+"</div>",messagePossibleQuestions.innerHTML+='<div class="clear"></div>',_ventanaChat.appendChild(messagePossibleQuestions),a=a+messagePossibleQuestions.offsetHeight+20}e.suggestion&&(messageSuggestionTopics=document.createElement("div"),messageSuggestionTopics.className="suggestion-topics",messageSuggestionTopics.innerHTML=e.suggestion,_ventanaChat.appendChild(messageSuggestionTopics),addMessageClear(),a=a+messageSuggestionTopics.offsetHeight+20),_ventanaChat.scrollTop=_ventanaChat.scrollHeight-a-35},escribirEnviarMensaje=function(e){if(""!=e){var a={from:"user",message:e.replace(/(?:\r\n|\r|\n)/g,"<br />"),time:currentTime()};store.saveMessage(a),escribirMensaje(a),sesion?enviarMensaje(e):(sesion=!0,enviarMensaje(start_message))}},escribirMensaje=function(e){sesion&&(_msjChat.value="",addYo(),struct=document.createElement("div"),struct.className="message send",struct.innerHTML='<div class="message-meta"></div><div class="message-block"><p>'+e.message+'</p></div><div class="time">'+e.time+"</div>",_ventanaChat.appendChild(struct),addMessageClear())},renderearConversacion=function(e){mostrarLoad(),context=JSON.stringify(e.context);for(a=0;a<e.conversation.length;a++)"watson"==e.conversation[a].from&&(e.conversation[a].context={},a+1<e.conversation.length&&(e.conversation[a].possible_questions=""));for(a=e.conversation.length-1;a>=0;a--)if("watson"==e.conversation[a].from){e.conversation[a].context=e.context;break}for(var a=0;a<e.conversation.length;a++){var t=e.conversation[a];"watson"==t.from?writeAnswer(t):escribirMensaje(t)}},enviarMensaje=function(e){mostrarLoad();var a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),t={BGBAHeader:{Identificadores:{IdMensaje:{"-schemaId":"HJP","#text":"1"},IdMensajeAnterior:{"-schemaId":"HJP","#text":"1"},IdOperacion:{"-schemaId":"HJP","#text":"1"}},ModuloAplicativo:{IdGalicia:"App-203",IdConsumidor:"nlnotes.exe",IdProveedor:"ArqCorp"},Equipo:{"-ip":"10.1.6.30","-nombre":"GAL069018"},Origen:{ModuloAplicativo:{IdGalicia:"App-203",IdConsumidor:"nlnotes.exe",IdProveedor:"ArqCorp"},Canal:"Mod-203",OrganizacionInterna:{"-tipo":"CC","-id":"1253"},Equipo:{"-ip":"10.1.6.30","-nombre":"GAL069018"},Terminal:"PLA0800",FechaHoraCreacion:"2009-05-31T13:20:00.000-03:00",Operador:{"-schemaId":"LEGAJO","#text":"L0151335"},Supervision:"L0151319"}},Datos:{TextoConsulta:e,Contexto:Contextoanterior}};return a.open("POST",PROXY_URL),a.setRequestHeader("Content-Type","application/json"),a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var e=JSON.parse(a.responseText);Contextoanterior=e.Datos.Contexto,t.Datos.Contexto.USR_03_options=[],responder(e),console.log(e)}},horario=currentTime(),t.Datos.Contexto.USR_10_current_time=horario,vMsg=JSON.stringify(t),console.log(t),a.send(vMsg),console.log(e),a};String.prototype.replaceAll=function(e,a){return this.replace(new RegExp(e,"g"),a)};var mostrarPreguntasPosibles=function(e){var a={from:"watson",message:e.parentElement.parentElement.getElementsByClassName("hidden-possible-questions")[0].innerHTML,confidence:"",time:currentTime()};store.saveMessage(a),writeAnswer(a),borrarPreguntasPosibles(e)},borrarPreguntasPosibles=function(e){var a=e.parentElement.parentElement;_ventanaChat.removeChild(a)},estrella_actual=1,estrellaHoverIn=function(e){for(var a=parseInt(e.target.getAttribute("data-star")),t=1;t<=a;t++){var s=document.querySelectorAll('[data-star="'+t+'"]')[0];s.className.indexOf("active")<0&&(s.className+=" active")}},estrellaHoverOut=function(){for(var e=0;e<_estrellas.length;e++){var a=_estrellas[e];a.className.indexOf("hold")<0&&(a.className="")}},estrellaClick=function(e){e.preventDefault();var a=parseInt(e.target.getAttribute("data-star"));estrella_actual=a;for(t=1;t<_estrellas.length;t++)(s=_estrellas[t]).className="";for(var t=1;t<=a;t++){var s=document.querySelectorAll('[data-star="'+t+'"]')[0];s.className="active hold"}_enviarSatisfaccion.className=_enviarSatisfaccion.className.replace("active",""),_enviarSatisfaccion.className+=" active"},reiniciarEstrellas=function(){estrella_actual=1;for(var e=0;e<_estrellas.length;e++)_estrellas[e].className="";_enviarSatisfaccion.className=_enviarSatisfaccion.className.replace("active","")};messageLoad=document.createElement("div"),messageLoad.id="load-message",messageLoad.className="load",messageLoad.innerHTML='<div class="loadind2"><div class="loading2-dot"></div><div class="loading2-dot"></div><div class="loading2-dot"></div></div>';var mostrarLoad=function(){esconderLoad(),_ventanaChat.appendChild(messageLoad),addMessageClear("clear-load"),_ventanaChat.scrollTop=_ventanaChat.scrollHeight},esconderLoad=function(){var e=document.getElementById("load-message");e&&e.parentNode.removeChild(e),(e=document.getElementById("clear-load"))&&e.parentNode.removeChild(e)},addMessageClear=function(e){var a=document.createElement("div");a.className="clear",void 0!==e&&(a.id=e),_ventanaChat.appendChild(a)},currentTime=function(){var e=new Date;return _z(e.getHours(),2)+":"+_z(e.getMinutes(),2)},_z=function(e,a){return(""+(Math.pow(10,a)+e)).slice(1)},resetStore=function(){store&&store.stop(),store&&store.clearConversation(),store=new Store(renderearConversacion)},Store=function(e){var a,t=this,s="w",n="wl";t.length=0,this.init=function(){t.supported=o(),started=!1,t.supported&&(r(s,1)||r(n)?t.length=r(n):t.clearConversation(),x=null)},this.stop=function(){a&&clearInterval(a)},this.saveContext=function(e){if(t.supported){var a=r(s,1);void 0!=a&&(a.contexto=contexto,i(s,a,1))}},this.saveMessage=function(e){if(t.supported){var a=r(s,1);"object"==typeof a?(a.conversation.push(e),t.length=a.conversation.length,i(s,a,1),i(n,t.length)):t.clearConversation(),c()}},this.getConversation=function(){var e=r(s,1);if(void 0!=e&&("{}"!=JSON.stringify(e.contexto)||e.conversation.length))return c(),e},this.clearConversation=function(){t.supported&&(i(s,{contexto:{},conversation:[]},1),i(n,0),t.length=0,sesion=!0)};var o=function(){try{return localStorage.setItem("supported","supported"),localStorage.removeItem("supported"),!0}catch(e){return!1}},i=function(e,a,s){if(t.supported){var n=JSON.stringify(a);localStorage.setItem(e,n)}},r=function(e,a){if(t.supported){var s=localStorage.getItem(e);if(s&&(!a||0!=s))return s=JSON.parse(s)}},c=function(){started=!0,a=a||setInterval(l,2e3)},l=function(){var a=parseInt(r(n));if(Math.abs(t.length-a))if("object"==typeof(a=t.getConversation())){var s=a.conversation.length;a.conversation.splice(0,t.length),t.length=s,i(n,t.length),e(a)}else t.clearConversation()};this.init()},_m=sesion_time,_p=function(e){var a=new Date;e&&a.setMinutes(a.getMinutes()-_m);var t=6e4*_m,s=3e4*_m,n=a.getTime()+s,o=n%t;return Math.round(new Date(s>=o?n-o:n+t-o).getTime()/1e3).toString()},_ls=function(){var e,a=0;for(e in localStorage)a+=2*(localStorage[e].length+e.length);return(a/1024).toFixed(2)+" KB"},addGala=function(e){var a=document.createElement("div");a.className="gala",a.innerHTML='<div class="gala">Gala</div>',void 0!==e&&(a.id=e),_ventanaChat.appendChild(a)},addYo=function(e){var a=document.createElement("div");a.className="yo",a.innerHTML='<div class="yo">Yo</div>',void 0!==e&&(a.id=e),_ventanaChat.appendChild(a)},store,sesion=!0,sesion_time=1,start_message="hola",Contextoanterior={},horario,_body,_abrirChat,_cerrarChat,_minimizarChat,_msjChat,_ventanaChat,_visorImg,_botonEnviar,_messengerCuerpo,_cerrarPopup,_satisfaccion,_enviarSatisfaccion,_cerrarSatisfaccion,_minimizarSatisfaccion,_estrellas,value,context="";document.addEventListener("DOMContentLoaded",function(e){_body=document.getElementsByTagName("BODY")[0],_abrirChat=document.getElementsByClassName("launcher")[0],_messengerCuerpo=document.getElementsByClassName("messenger")[0],_cerrarChat=document.getElementById("closeChat"),_minimizarChat=document.getElementById("minimizeChat"),_msjChat=document.getElementById("chatMessage"),_ventanaChat=document.getElementById("chatWindow"),_visorImg=document.getElementById("viewer"),_botonEnviar=document.getElementById("send-button"),_satisfaccion=document.getElementById("satisfaction"),_enviarSatisfaccion=document.getElementById("sendSatisfaction"),_cerrarSatisfaccion=document.getElementById("closeSatisfaction"),_minimizarSatisfaccion=document.getElementById("minimizeSatisfaction"),_estrellas=document.querySelectorAll("[data-star]");document.documentMode;_abrirChat.addEventListener("click",abrirChat,!1),_cerrarChat.addEventListener("click",cerrarChat,!1),_minimizarChat.addEventListener("click",minimizarChat,!1),_cerrarSatisfaccion.addEventListener("click",enviarSatisfaccionNula,!1),_minimizarSatisfaccion.addEventListener("click",minimizarSatisfaccion,!1),_enviarSatisfaccion.addEventListener("click",enviarSatisfaccion,!1),_ventanaChat.addEventListener("click",chatWindowClick,!1);for(var a=0;a<_estrellas.length;a++)_estrellas[a].addEventListener("click",estrellaClick,!1),_estrellas[a].addEventListener("mouseover",estrellaHoverIn,!1),_estrellas[a].addEventListener("mouseout",estrellaHoverOut,!1);_msjChat.onkeypress=function(e){if(13==e.keyCode&&!e.shiftKey)return escribirEnviarMensaje(_msjChat.value),!1},_botonEnviar.addEventListener("click",botonEnviar,!1);var t=!0;window.onbeforeunload=function(e){var a=_body.className;if(t&&a.indexOf("display-chat")>-1)return t=!1,!0},comenzarChat()});
